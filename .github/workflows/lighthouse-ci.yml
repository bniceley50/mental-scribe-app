name: Lighthouse CI

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build application
        run: pnpm build
        env:
          NODE_ENV: production
      
      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.13.x
      
      - name: Start preview server
        run: |
          pnpm preview &
          npx wait-on http://localhost:4173 --timeout 60000
        env:
          BASE_URL: http://localhost:4173
      
      - name: Run Lighthouse CI
        run: lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload Lighthouse results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-results
          path: .lighthouseci/
          retention-days: 30
      
      - name: Check performance budgets
        run: |
          echo "ðŸ“Š Performance Budget Check"
          
          # Extract scores from the latest run
          PERF_SCORE=$(jq -r '.[0].categories.performance.score * 100' .lighthouseci/lhr-*.json | head -1)
          A11Y_SCORE=$(jq -r '.[0].categories.accessibility.score * 100' .lighthouseci/lhr-*.json | head -1)
          BEST_PRACTICES=$(jq -r '.[0].categories["best-practices"].score * 100' .lighthouseci/lhr-*.json | head -1)
          SEO_SCORE=$(jq -r '.[0].categories.seo.score * 100' .lighthouseci/lhr-*.json | head -1)
          
          echo "Performance: $PERF_SCORE"
          echo "Accessibility: $A11Y_SCORE"
          echo "Best Practices: $BEST_PRACTICES"
          echo "SEO: $SEO_SCORE"
          
          # Performance budgets
          MIN_PERF=75
          MIN_A11Y=90
          MIN_BP=85
          MIN_SEO=85
          
          FAILED=0
          
          if (( $(echo "$PERF_SCORE < $MIN_PERF" | bc -l) )); then
            echo "âŒ Performance score too low: $PERF_SCORE < $MIN_PERF"
            FAILED=1
          fi
          
          if (( $(echo "$A11Y_SCORE < $MIN_A11Y" | bc -l) )); then
            echo "âŒ Accessibility score too low: $A11Y_SCORE < $MIN_A11Y"
            FAILED=1
          fi
          
          if (( $(echo "$BEST_PRACTICES < $MIN_BP" | bc -l) )); then
            echo "âŒ Best practices score too low: $BEST_PRACTICES < $MIN_BP"
            FAILED=1
          fi
          
          if (( $(echo "$SEO_SCORE < $MIN_SEO" | bc -l) )); then
            echo "âŒ SEO score too low: $SEO_SCORE < $MIN_SEO"
            FAILED=1
          fi
          
          if [ $FAILED -eq 1 ]; then
            exit 1
          fi
          
          echo "âœ… All performance budgets met!"
