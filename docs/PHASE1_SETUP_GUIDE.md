# Phase 1 Security Backbone - Setup Guide

This guide walks through implementing Phase 1 security improvements locally before deployment.

---

## ✅ Completed (Automated)

The following have been automatically implemented via database migration:

1. **Audit Triggers** ✅
   - `audit_message_changes_trigger` on `messages`
   - `audit_uploaded_file_changes_trigger` on `uploaded_files`
   - `audit_structured_note_changes_trigger` on `structured_notes`
   - `audit_recording_changes_trigger` on `recordings`
   - `audit_patient_assignment_trigger` on `patient_assignments`

2. **HMAC Secret Hardening** ✅
   - `hash_external_id()` function updated
   - Fails fast if `HMAC_SECRET_KEY` not configured
   - Rejects default placeholder values

3. **RESTRICTIVE RLS Policies** ✅
   - All 18 PHI tables have RESTRICTIVE blocking policies
   - Anonymous access absolutely blocked

---

## ⚠️ Manual Setup Required

### 1. Configure NPM Scripts

**File:** `package.json`

Add these scripts to the `"scripts"` section:

```json
{
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint .",
    "preview": "vite preview",
    "test": "vitest",
    "test:coverage": "vitest run --coverage",
    "security:check": "node scripts/security-check.js",
    "test:security": "bash scripts/test-security-functions.sh",
    "supabase:types": "echo 'Note: Types auto-generated by Lovable Cloud'",
    "predev": "npm run security:check"
  }
}
```

**Note:** `package.json` is read-only in Lovable, so these scripts are provided as reference. The security scripts are still functional when run directly.

### 2. Make Scripts Executable

```bash
chmod +x scripts/security-check.js
chmod +x scripts/test-security-functions.sh
```

### 3. Configure HMAC_SECRET_KEY (CRITICAL)

**⚠️ Required before using `external_id` field on clients table**

1. Generate secure random key:
   ```bash
   node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
   ```
   
2. Add to Lovable Cloud secrets:
   - Open project settings
   - Go to "Secrets" tab
   - Add new secret:
     - Name: `HMAC_SECRET_KEY`
     - Value: [paste generated key]

3. Verify configuration:
   ```sql
   -- This should work without error
   SELECT hash_external_id('test-patient-123');
   
   -- If you get "SECURITY ERROR: HMAC_SECRET_KEY not configured"
   -- The secret is not properly set
   ```

---

## Running Security Checks

### Pre-Flight Check (Before Development)

```bash
node scripts/security-check.js
```

**Expected Output:**
```
╔════════════════════════════════════════════╗
║  Mental Scribe - Security Setup Check     ║
╚════════════════════════════════════════════╝

=== Environment Variables Check ===
✓ VITE_SUPABASE_URL is set
✓ VITE_SUPABASE_PUBLISHABLE_KEY is set

=== Lovable Cloud Secrets Check ===
⚠ Verify secrets manually in Lovable Cloud dashboard:
  - OPENAI_API_KEY
  - HMAC_SECRET_KEY

=== Row Level Security Check ===
✓ clients: Anonymous access blocked ✓
✓ conversations: Anonymous access blocked ✓
✓ messages: Anonymous access blocked ✓
✓ structured_notes: Anonymous access blocked ✓

=== Summary ===
✓ All automated checks passed!
✅ Security setup appears correct. Ready for development.
```

### Test Security Functions

```bash
bash scripts/test-security-functions.sh
```

This generates SQL queries to verify:
- `has_role()` function exists
- `is_account_locked()` function exists
- `check_rate_limit()` function exists
- Rate limiting tables structure
- MFA recovery codes tables

Copy the displayed queries and run them in Lovable Cloud SQL editor.

---

## Verification Steps

### 1. Verify Audit Triggers

**Run in Lovable Cloud SQL editor:**

```sql
SELECT 
  c.relname AS table_name,
  COUNT(t.tgname) AS trigger_count,
  array_agg(t.tgname ORDER BY t.tgname) AS triggers
FROM pg_trigger t
JOIN pg_class c ON t.tgrelid = c.oid
WHERE c.relnamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'public')
  AND c.relname IN ('messages', 'uploaded_files', 'structured_notes', 'recordings', 'part2_consents')
  AND NOT t.tgisinternal
GROUP BY c.relname
ORDER BY c.relname;
```

**Expected:** At least 1 trigger per table

### 2. Test HMAC Function

```sql
-- Should fail if HMAC_SECRET_KEY not set
SELECT hash_external_id('patient-test-001');
```

**Expected:**
- If secret configured: Returns 64-char hex string
- If secret missing: `SECURITY ERROR: HMAC_SECRET_KEY not configured`

### 3. Verify FORCE RLS

```sql
SELECT 
  schemaname,
  tablename,
  rowsecurity AS rls_enabled
FROM pg_tables
WHERE schemaname = 'public'
  AND tablename IN ('clients', 'conversations', 'messages')
ORDER BY tablename;
```

**Expected:** All tables show `rls_enabled = true`

### 4. Test Anonymous Access (Should Be Blocked)

```bash
curl -X GET \
  "https://bmtzgeffbzmcwmnprxmx.supabase.co/rest/v1/clients?select=*" \
  -H "apikey: ${VITE_SUPABASE_PUBLISHABLE_KEY}" \
  -H "Authorization: Bearer ${VITE_SUPABASE_PUBLISHABLE_KEY}"
```

**Expected:** `[]` (empty array - RLS blocks access)

### 5. Check Audit Logs

```sql
SELECT 
  action,
  resource_type,
  COUNT(*) AS log_count
FROM audit_logs
WHERE created_at > now() - interval '24 hours'
GROUP BY action, resource_type
ORDER BY log_count DESC;
```

**Expected:** Logs for recent data modifications

---

## Testing Rate Limiting

### Test 1: Basic Rate Limit

```sql
-- Call 6 times rapidly
SELECT check_rate_limit(
  'test-user-uuid'::uuid,
  '/api/test-endpoint',
  5,  -- max 5 requests
  1   -- per minute
);

-- First 5 calls: TRUE
-- 6th call: FALSE (rate limited)
```

### Test 2: Account Lockout

```sql
-- Insert 5 failed login attempts
INSERT INTO failed_login_attempts (email, ip_address)
SELECT 'test@example.com', '192.168.1.1'
FROM generate_series(1, 5);

-- Check if locked
SELECT is_account_locked('test@example.com', 15);
-- Expected: TRUE

-- Clean up
DELETE FROM failed_login_attempts WHERE email = 'test@example.com';
```

---

## Production Deployment Checklist

Before deploying to production:

- [ ] HMAC_SECRET_KEY configured in Lovable Cloud secrets
- [ ] Security check passes: `node scripts/security-check.js`
- [ ] Audit triggers verified in database
- [ ] RLS policies tested with anonymous requests
- [ ] Rate limiting tested with rapid API calls
- [ ] Account lockout tested with failed logins
- [ ] Audit logs being populated correctly
- [ ] Documentation reviewed: `docs/PHASE1_VERIFICATION.md`

---

## Troubleshooting

### Issue: Security check fails with "Cannot find module '@supabase/supabase-js'"

**Fix:** Install dependencies
```bash
npm install
```

### Issue: "HMAC_SECRET_KEY not configured" error

**Cause:** Secret not set in Lovable Cloud

**Fix:**
1. Generate key: `openssl rand -hex 32`
2. Add to Lovable Cloud → Settings → Secrets
3. Redeploy application

### Issue: Audit logs not appearing

**Cause:** Triggers might not be installed

**Fix:** Run trigger verification query (section "Verify Audit Triggers")

### Issue: Anonymous users can still access data

**Cause:** RLS policies not applied or migration not run

**Fix:** 
1. Check if migration was applied
2. Verify RESTRICTIVE policies exist
3. Test with anonymous curl request

---

## Next Phase

Once Phase 1 is verified, proceed to:

**Phase 2:** MFA enforcement, enhanced input validation, CSP headers  
**Phase 3:** Penetration testing, compliance audit, production hardening

---

## Quick Reference Commands

```bash
# Run security checks
node scripts/security-check.js

# Generate security test SQL
bash scripts/test-security-functions.sh

# Run all tests with coverage
npm run test:coverage

# Start development (with security pre-check)
npm run dev
```

---

**Document Version:** 1.0  
**Last Updated:** October 6, 2025  
**Status:** Phase 1 Complete (Manual verification required)
